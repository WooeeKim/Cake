<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Make a Cake with Me! - Naeun Kim (v2)</title>
  <style>
    :root{
      --bg:#fef6f8; /* pastel background */
      --cake:#ffe6e6; /* pastel pink cake */
      --icing:#fff9fc; /* light pink icing */
      --plate:#f0f7ff; /* light blue plate */
      --accent:#ffb5c9; /* soft pink accent */
      --candle-colors: #ffd6e6, #c9f4ff, #ffecd6, #e8ffd6, #e5d6ff, #ffd6d6;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background: radial-gradient(1200px 600px at 50% 80%, #ffeef5 0%, #e9f5ff 60%, #fff6e9 100%);
      color:#6a5d7b;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow:hidden;
    }
    #hud{
      position:fixed; left:16px; top:16px; padding:12px 14px; border-radius:14px;
      background:rgba(255,255,255,0.06); backdrop-filter: blur(6px);
      line-height:1.4; font-size:14px; max-width: 560px; border:1px solid rgba(255,255,255,0.1);
      transition: opacity .25s ease, transform .25s ease, visibility .25s;
    }
    #hud.hidden{ opacity:0; transform: translateY(-6px); visibility:hidden; }
    #hud kbd{background:#22263a;border:1px solid #2f3552;padding:2px 6px;border-radius:6px}
    #hud .mini{font-size:12px; color:#b9c2df}

    #hud-toggle{
      position:fixed; left:16px; top:16px; width:36px; height:36px; border-radius:10px;
      background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12);
      display:grid; place-items:center; cursor:pointer; font-weight:800; user-select:none;
      transition: transform .15s ease; backdrop-filter: blur(6px);
    }
    #hud-toggle:hover{ transform: scale(1.05); }

    #stage{position:relative; width:100%; height:100%;}

    /* Empty roof section removed */

    /* Plate */
    .plate{ position:absolute; left:50%; bottom:4%; transform:translateX(-50%);
      width: 56vw; height: 2.6vw; min-height:18px; background: var(--plate);
      border-radius: 80px; filter: drop-shadow(0 24px 40px rgba(0,0,0,0.35));
    }
    /* Cake body */
    .cake{ position:absolute; left:50%; bottom:7.5%; transform:translateX(-50%);
      width: 48vw; max-width: 900px; min-width: 360px; height: 24vw; min-height: 240px;
      background: linear-gradient(180deg, #ffeee8 0%, #ffe7de 30%, var(--cake) 100%); 
      border-radius: 24px; overflow:visible;
      box-shadow: 
        inset 0 -20px 0 #ffb5c9,
        inset 0 -40px 0 rgba(255, 181, 201, 0.6),
        0 40px 80px rgba(0,0,0,0.15);
    }
    
    /* Shell icing border at bottom */
    .cake::after{ 
      content:""; position:absolute; left:0; right:0; bottom:-8px; height: 32px; 
      background: linear-gradient(90deg, #ffb5c9 0%, #ffc9d4 25%, #ffb5c9 50%, #ffc9d4 75%, #ffb5c9 100%);
      border-radius: 0 0 24px 24px;
      background-image: 
        repeating-linear-gradient(90deg, 
          transparent 0px, 
          transparent 8px, 
          rgba(255,255,255,0.3) 8px, 
          rgba(255,255,255,0.3) 12px, 
          transparent 12px, 
          transparent 20px
        ),
        radial-gradient(ellipse 15px 8px at 8% 40%, rgba(255,255,255,0.4) 0%, transparent 100%),
        radial-gradient(ellipse 12px 6px at 20% 60%, rgba(255,255,255,0.3) 0%, transparent 100%),
        radial-gradient(ellipse 18px 9px at 35% 45%, rgba(255,255,255,0.4) 0%, transparent 100%),
        radial-gradient(ellipse 14px 7px at 50% 55%, rgba(255,255,255,0.3) 0%, transparent 100%),
        radial-gradient(ellipse 16px 8px at 65% 40%, rgba(255,255,255,0.4) 0%, transparent 100%),
        radial-gradient(ellipse 13px 6px at 80% 60%, rgba(255,255,255,0.3) 0%, transparent 100%),
        radial-gradient(ellipse 15px 8px at 92% 45%, rgba(255,255,255,0.4) 0%, transparent 100%);
      box-shadow: 
        inset 0 3px 0 rgba(255,255,255,0.2),
        inset 0 -3px 0 rgba(255,181,201,0.4),
        0 4px 8px rgba(0,0,0,0.1);
      z-index: 2;
    }
    
    /* Cream waves on top */
    .cake::before{
      content:""; position:absolute; left:0; right:0; top:-8px; height: 24px; 
      background: linear-gradient(90deg, #fff9fc 0%, #ffeef5 50%, #fff9fc 100%);
      border-radius: 50px;
      background-image: 
        radial-gradient(ellipse 20px 8px at 15% 50%, rgba(255,255,255,0.8) 0%, transparent 70%),
        radial-gradient(ellipse 25px 10px at 35% 50%, rgba(255,255,255,0.6) 0%, transparent 70%),
        radial-gradient(ellipse 18px 7px at 55% 50%, rgba(255,255,255,0.8) 0%, transparent 70%),
        radial-gradient(ellipse 22px 9px at 75% 50%, rgba(255,255,255,0.7) 0%, transparent 70%),
        radial-gradient(ellipse 20px 8px at 90% 50%, rgba(255,255,255,0.8) 0%, transparent 70%);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      z-index: 1;
    }

    /* Candles */
    .candle{ 
      position:absolute; 
      bottom: calc(24vw + 15px);
      width: 5px;
      height: 180px; /* ë” ê¸¸ê²Œ */
      border-radius: 2.5px;
      background:
        repeating-linear-gradient(
          45deg,
          #fff 0px, #fff 6px,
          transparent 6px, transparent 12px
        ),
        linear-gradient(to bottom, var(--accent), #ffffff);
      user-select:none;
      transform-origin: bottom center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .candle.lit {
      filter: drop-shadow(0 0 8px rgba(255, 200, 100, 0.5));
    }
    .candle.lit::after {
      content: "";
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 12px;
      background: radial-gradient(circle at center, #fff7c9 20%, #ffed4a 45%, transparent 70%);
      border-radius: 50%;
      animation: flicker 1s ease-in-out infinite alternate;
      box-shadow: 
        0 0 15px 5px rgba(255, 237, 74, 0.4),
        0 0 30px 15px rgba(255, 186, 66, 0.2);
    }
    
    @keyframes flicker {
      0% { transform: translateX(-50%) scale(1); opacity: 0.9; }
      100% { transform: translateX(-50%) scale(1.1); opacity: 1; }
    }

  /* Falling bits (letters / toppings) â€” sizes increased 200% */
  /* Doubled the font-sizes so letters and fruit emojis appear 200% larger */
  .bit{ position:absolute; top:-40px; font-weight:700; font-size: clamp(32px, 3.2vw, 56px); user-select:none; }
  .bit.letter{ color:#fff; text-shadow: 0 2px 0 rgba(0,0,0,0.4), 0 0 18px rgba(255,174,213,0.35);}    
  .bit.topping{ filter: drop-shadow(0 2px 2px rgba(0,0,0,0.35)); font-size: clamp(40px, 3.6vw, 68px);}    
  .bit.giant{ font-size: clamp(128px, 14vw, 240px); }

  /* Sprinkles doubled in pixel size for visual balance */
  .sprinkle{ width:16px; height:16px; border-radius:50%; position:absolute; top:-10px; }

    @keyframes fall { to { transform: translateY(var(--fallY, 86vh)); opacity: 1; } }
    @keyframes eat  { to { transform: translateX(120vw) rotate(8deg); opacity:0 } }

    .falling{ animation: fall linear var(--dur,3.2s); }
    .eaten{ animation: eat 900ms ease-in forwards; }

    /* Room lighting when candles on - ë” ì–´ë‘¡ê³  ê·¹ì ì¸ íš¨ê³¼ */
    .warm{
      background: radial-gradient(1200px 600px at 50% 65%, #2a1a0d 0%, #1b1d29 40%, #2d1933 70%, #1a1a24 90%, var(--bg) 100%);
      transition: background 0.5s cubic-bezier(.4,0,.2,1);
    }

    /* Guest hand */
    .hand{ position:absolute; right:-20vw; top:40%; font-size: clamp(42px, 6vw, 100px); filter: drop-shadow(0 8px 14px rgba(0,0,0,0.35));}

    /* Footer + Buttons */
    #footer{ position:fixed; right:16px; bottom:14px; opacity:0.85; font-size:12px; color:#b7bfd8; }
    .pill{
      position:fixed; right:16px; bottom:46px; padding:10px 12px; border-radius:999px; cursor:pointer;
      background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); user-select:none;
      backdrop-filter: blur(6px); transition: transform .12s ease; font-size:13px; color:#e7eaf6;
    }
    .pill:active{ transform: translateY(1px); }
  </style>
</head>
<body>
  <div id="hud-toggle" title="ë„ì›€ë§ ë³´ê¸°/ìˆ¨ê¸°ê¸°">?</div>
  <div id="hud">
    <div><strong>Make a Cake with Me! - Naeun Kim</strong></div>
    <div class="mini">ê¸€ìê°€ ì¼€ì´í¬ì— ìŒ“ì—¬ìš” â€¢ ì†ë‹˜ì´ ê°€ì ¸ê°€ìš” ğŸ° â†’ <kbd>Enter</kbd> ë˜ëŠ” ë²„íŠ¼</div>
    <div>ì¼ë°˜ í‚¤: <em>ê¸€ì</em>ê°€ ì¼€ì´í¬ì— ì¸µì¸µì´ ìŒ“ì—¬ìš”</div>
    <div><kbd>Space</kbd>: ì´›ë¶ˆ ì¼œê¸°/ë„ê¸° / <kbd>Enter</kbd>: ì†ë‹˜ì´ ê°€ì ¸ê°€ìš”(ì´ˆê¸°í™”)</div>
    <div>ìˆ«ìí‚¤: ìŠ¤í”„ë§í´ â€¢ ê°€ë”ì€ ê¹œì§ ìˆ˜ë°•ğŸ‰ì´ ë“±ì¥í•´ìš”!</div>
    <div class="mini">ê³¼ì¼ ë‹¨ì¶•í‚¤ë¥¼ ì°¾ìœ¼ë ¤ë©´ ë¬¼ìŒí‘œ(?) ì•„ì´ì½˜ì„ í´ë¦­í•´ë³´ì„¸ìš”</div>
    <div class="fruit-keys" style="display: none;">
      ğŸ“: Fí‚¤ / ğŸ: Aí‚¤ / ğŸ«: Bí‚¤ / ğŸ’: Cí‚¤ / ğŸ‡: Gí‚¤<br>
      ğŸ¥­: Mí‚¤ / ğŸ¥: Kí‚¤ / ğŸ‘: Pí‚¤ / ğŸŠ: Oí‚¤ / ï¿½: Lí‚¤
    </div>
  </div>

  <div id="stage">
    <div class="roof" aria-hidden="true"></div>
    <div class="plate"></div>
    <div id="cake" class="cake" aria-label="cake"></div>
  </div>

  <button id="resetBtn" class="pill" title="ì†ë‹˜ì´ ê°€ì ¸ê°€ìš”">ğŸ«±ğŸ»â€ğŸ° ì†ë‹˜ì´ ê°€ì ¸ê°€ìš”</button>
  <div id="happyBirthday" style="display:none;position:absolute;top:10vw;left:50%;transform:translateX(-50%);font-size:3vw;font-weight:bold;color:#ff69b4;text-shadow:0 2px 8px #fff,0 0 20px #ff69b4;z-index:999;">Happy Birthday!</div>
  <div id="footer">type to play â€¢ made for ID202 prototyping</div>

  <script>
  // ===== Audio â€” tiny synth & candle pad =====
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioContext = null;
  function getAudioContext(){ if(!audioContext) audioContext = new AudioCtx(); return audioContext; }

  function noteForKey(key){
    const scale = [261.63, 293.66, 329.63, 392.00, 440.00]; // C D E G A
    const index = (key.toUpperCase().charCodeAt(0) + 7) % scale.length;
    return scale[index] * (1 + ((key.charCodeAt(0)%5)-2)*0.01);
  }

  function blip(key){
    const ac = getAudioContext();
    const osc = ac.createOscillator();
    const gain = ac.createGain();
    osc.type = 'triangle';
    osc.frequency.value = noteForKey(key);
    gain.gain.value = 0.001;
    osc.connect(gain).connect(ac.destination);
    const now = ac.currentTime;
    gain.gain.linearRampToValueAtTime(0.12, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0008, now + 0.22);
    osc.start();
    osc.stop(now + 0.25);
  }

  let candleOsc = null, candleGain = null;
  function candleOn(){
    const ac = getAudioContext();
    candleOsc = ac.createOscillator();
    candleGain = ac.createGain();
    candleOsc.type = 'sine';
    candleOsc.frequency.value = 196;
    candleGain.gain.value = 0.0001;
    candleOsc.connect(candleGain).connect(ac.destination);
    const now = ac.currentTime;
    candleGain.gain.linearRampToValueAtTime(0.06, now + 0.6);
  candleOsc.start();
  // Happy Birthday! ë…¸ì¶œ: ì‹¤ì œ ì¼€ì´í¬ì— ì´ˆê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ
  setTimeout(()=>{
    if(document.querySelector('.candle')){
      document.getElementById('happyBirthday').style.display = 'block';
    }
  }, 100);
  }
  function candleOff(){
    if(!candleGain || !candleOsc) return;
    const ac = getAudioContext();
    const now = ac.currentTime;
    candleGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
  candleOsc.stop(now + 0.25);
  candleGain = null; candleOsc = null;
  // Happy Birthday! ìˆ¨ê¹€
  document.getElementById('happyBirthday').style.display = 'none';
  }

  // ===== Scene =====
  const stage = document.getElementById('stage');
  const cake  = document.getElementById('cake');
  const hud   = document.getElementById('hud');
  const hudToggle = document.getElementById('hud-toggle');
  const resetBtn = document.getElementById('resetBtn');
  let candlesLit = false;

  const randomBetween = (min,max)=> Math.random()*(max-min)+min;
  function cakeRect(){ return cake.getBoundingClientRect(); }

  // ===== Landing position calculation =====
  function landingYOnCake() {
    const cr = cakeRect();
    const surfaceY = cr.top + 20;          // ì¼€ì´í¬ í‘œë©´ ê¸°ì¤€
    return surfaceY - randomBetween(0, 30); // í‘œë©´ ê·¼ì²˜ ëœë¤ ì°©ì§€
  }

  function getRandomXOnCake() {
    const cr = cakeRect();
    return cr.left + (cr.width * 0.15) + Math.random() * (cr.width * 0.7);
  }

  // Candle specific functions
  function placeCandleOnCake(candle) {
    const cr = cakeRect();
    const colors = getComputedStyle(document.documentElement)
      .getPropertyValue('--candle-colors').split(',');
    const color = colors[Math.floor(Math.random() * colors.length)].trim();
    candle.style.background = `linear-gradient(to bottom, ${color}, #ffffff)`;
    
    const x = cr.left + (cr.width * (Math.random() * 0.6 + 0.2));
    candle.style.left = x + 'px';
    candle.style.transform = `rotate(${randomBetween(-2, 2)}deg)`;
    candle.classList.remove('falling');
  }

  // initialize stacking after layout
  window.addEventListener('load', ()=> stacking.recompute());
  window.addEventListener('resize', ()=> stacking.recompute());

  // ===== Candles =====
  function placeCandles(){
    [...document.querySelectorAll('.candle')].forEach(c=>c.remove());
    const cr = cakeRect();
    const count = 5;
    for(let i=0;i<count;i++){
      const c = document.createElement('div');
      c.className = 'candle';
      c.innerHTML = '<div class="flame">ï¿½</div>';
      const x = (cr.left + (cr.width*(0.15 + i*(0.7/(count-1))))) - 14;
      c.style.left = x + 'px';
      stage.appendChild(c);
    }
  }
  function toggleCandles(){
    candlesLit = !candlesLit;
    if(candlesLit){
      placeCandles();
      document.body.classList.add('warm');
      candleOn();
    } else {
      document.body.classList.remove('warm');
      candleOff();
      [...document.querySelectorAll('.candle')].forEach(c=>c.remove());
    }
  }

  // ===== Spawn helpers =====
  function spawnBit({ text, className, emoji, color, fromRoof=false, giant=false, group=false, node=null }){
    const bit = node || document.createElement('div');
    bit.className = 'bit falling ' + (className||'');
    if(giant) bit.classList.add('giant');
    bit.style.setProperty('--dur', (randomBetween(2.0, 3.6)).toFixed(2)+'s');

    const stageRect = stage.getBoundingClientRect();
    const roofRect = document.querySelector('.roof').getBoundingClientRect();
    const startX = fromRoof
      ? randomBetween(roofRect.left + 20, roofRect.right - 20)
      : randomBetween(stageRect.width*0.18, stageRect.width*0.82);

    bit.style.left = startX + 'px';
    bit.style.opacity = 0.96;

    if(emoji){ bit.textContent = emoji; }
    else if(text){ bit.textContent = text; }
    if(color){ bit.style.color = color; }

    stage.appendChild(bit);

    // ===== Xì¢Œí‘œë³„ë¡œ ìŒ“ì„ ë¡œì§ ê°œì„  =====
    const cr = cakeRect();
    let bitHeight = bit.offsetHeight || 40;
    if(bit.classList.contains('giant')) bitHeight = 120;
    else if(bit.classList.contains('topping')) bitHeight = 68;
    const surfaceY = cr.top + 20;
    // ë‚´ Xì¢Œí‘œ ì¤‘ì•™ê°’
    const myCenterX = startX + (bit.offsetWidth/2);
    // ë°”ë¡œ ì•„ë˜ì— ìŒ“ì¸ ìš”ì†Œê°€ ìˆëŠ”ì§€ í™•ì¸ (Xì¢Œí‘œê°€ ê±°ì˜ ê°™ì€ ê²ƒ)
    const bitsOnCake = Array.from(document.querySelectorAll('.bit')).filter(b => {
      if(b.classList.contains('falling')) return false;
      const bx = b.getBoundingClientRect().left + b.offsetWidth/2;
      return Math.abs(bx - myCenterX) < 20;
    });
    // 2ê°œê¹Œì§€ëŠ” í‘œë©´ì— ë°”ë¡œ, 3ë²ˆì§¸ë¶€í„° ìœ„ë¡œ ìŒ“ì„
    const stackIndex = Math.max(0, bitsOnCake.length - 2);
    const targetY_vp = surfaceY - randomBetween(0, 30) - (stackIndex * (bitHeight * 0.6)); // Adjusted for 40% overlap
    bit.dataset.targetY_vp = targetY_vp;
    const startTopPx = parseFloat(getComputedStyle(bit).top) || -40;
    const fallDistance = (targetY_vp - stageRect.top) - startTopPx;
    bit.style.setProperty('--fallY', `${fallDistance}px`);

    // Pre-calculate landing rotation and z-index
    bit.dataset.landRot = randomBetween(-15, 15);
    bit.style.zIndex = Math.floor(Math.random() * 100);

    bit.addEventListener('animationend', ()=> {
      const cr2 = cakeRect();
      const centerX = bit.getBoundingClientRect().left + bit.offsetWidth/2;
      if(centerX > cr2.left && centerX < cr2.right){
        // Fix position without transform
        const stageTop = stage.getBoundingClientRect().top;
        // ë°”ë¡œ ì•„ë˜ì— ìŒ“ì¸ ìš”ì†Œ(bottom ê¸°ì¤€) ì°¾ê¸°
        const bitsOnCake2 = Array.from(document.querySelectorAll('.bit')).filter(b => {
          if(b.classList.contains('falling') || b === bit) return false;
          const bx = b.getBoundingClientRect().left + b.offsetWidth/2;
          return Math.abs(bx - centerX) < 20;
        });
        // ì•„ë˜ì— ìŒ“ì¸ ìš”ì†Œê°€ ìˆìœ¼ë©´ ê·¸ ì¤‘ ê°€ì¥ ìœ„(bottomì´ ê°€ì¥ í° ê²ƒ) ë°”ë¡œ ìœ„ì— ë¶™ì„
        let finalTop;
        if(bitsOnCake2.length > 0){
          // 2ê°œê¹Œì§€ëŠ” í‘œë©´ì— ë°”ë¡œ, 3ë²ˆì§¸ë¶€í„° ìœ„ë¡œ ìŒ“ì„
          const sorted = bitsOnCake2.sort((a,b)=>a.getBoundingClientRect().top-b.getBoundingClientRect().top);
          const base = sorted[Math.min(1,sorted.length-1)]; // 2ê°œê¹Œì§€ëŠ” í‘œë©´ì—
          // baseì˜ topì—ì„œ ìì‹ ì˜ ë†’ì´ë§Œí¼ ìœ„ë¡œ ìŒ“ì„
          finalTop = base.getBoundingClientRect().top - bit.offsetHeight - stageTop;
        } else {
          // ì¼€ì´í¬ í‘œë©´ì— ë°”ë¡œ
          finalTop = (cr2.top + 20) - stageTop;
        }
        bit.style.top = `${finalTop}px`;
        bit.style.transform = `rotate(${bit.dataset.landRot}deg)`;
        bit.style.animation = 'none';
        bit.classList.remove('falling');
      } else {
        bit.remove();
      }
    });

    // Optional group cascade (3 quick neighbors)
    if(group){
      for(let i=0;i<3;i++){
        setTimeout(()=>{
          spawnBit({ text, className, emoji, color, fromRoof:true });
        }, 120 + i*80);
      }
    }
  }

  // íŒŒìŠ¤í…”í†¤ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ - ìŠ¤í”„ë§í´ê³¼ ê¸€ìì— ê³µí†µìœ¼ë¡œ ì‚¬ìš©
  const pastelPalette = ['#ff7a99','#ffd166','#8be9fd','#c2ff8f','#b197fc','#ffb5c9','#c9f4ff','#ffecd6'];
  
  function sprinkle(){
    const s = document.createElement('div');
    s.className = 'sprinkle falling';
    const stageRect = stage.getBoundingClientRect();
    s.style.left = randomBetween(stageRect.width*0.2, stageRect.width*0.8)+'px';
    s.style.background = pastelPalette[Math.floor(randomBetween(0, pastelPalette.length))];
    s.style.setProperty('--dur', (randomBetween(1.6, 2.6)).toFixed(2)+'s');
    
    // Pre-calculate landing position like spawnBit
    const startTopPx = -10; // .sprinkle default top:-10px
    const targetY_vp = landingYOnCake();
    s.dataset.targetY_vp = targetY_vp;
    const fallDistance = (targetY_vp - stageRect.top) - startTopPx;
    s.style.setProperty('--fallY', `${fallDistance}px`);
    
    // Pre-calculate landing rotation
    s.dataset.landRot = randomBetween(-15, 15);
    s.style.zIndex = Math.floor(Math.random() * 100);
    
    stage.appendChild(s);
    
    s.addEventListener('animationend', ()=> {
      const cr = cakeRect();
      const centerX = s.getBoundingClientRect().left + s.offsetWidth/2;
      if(centerX > cr.left && centerX < cr.right){
        // stacking: ê°™ì€ Xì¢Œí‘œì— ìŒ“ì¸ sprinkle ì°¾ê¸°
        const stageTop = stage.getBoundingClientRect().top;
        const sprinklesOnCake = Array.from(document.querySelectorAll('.sprinkle')).filter(b => {
          if(b.classList.contains('falling') || b === s) return false;
          const bx = b.getBoundingClientRect().left + b.offsetWidth/2;
          return Math.abs(bx - centerX) < 20;
        });
        let finalTop;
        if(sprinklesOnCake.length > 0){
          // ê°€ì¥ ìœ„ì— ìˆëŠ” sprinkle ìœ„ì— 40% ê²¹ì³ì„œ ìŒ“ê¸°
          const sorted = sprinklesOnCake.sort((a,b)=>a.getBoundingClientRect().top-b.getBoundingClientRect().top);
          const base = sorted[sprinklesOnCake.length-1];
          finalTop = base.getBoundingClientRect().top - s.offsetHeight * 0.6 - stageTop;
        } else {
          // ì¼€ì´í¬ í‘œë©´ì— ë°”ë¡œ
          finalTop = (cr.top + 20) - stageTop;
        }
        s.style.top = `${finalTop}px`;
        s.style.transform = `rotate(${s.dataset.landRot}deg)`;
        s.style.animation = 'none';
        s.classList.remove('falling');
      } else {
        s.remove();
      }
    });
  }

  // ===== Guest arrives (reset) =====
  function guestEat(){
    // ë°•ìŠ¤ ë™ì  ìƒì„± (ì¼€ì´í¬ ì „ì²´ ê°€ë¦´ í¬ê¸°)
    const cakeRect = cake.getBoundingClientRect();
    const stageRect = stage.getBoundingClientRect();
    const box = document.createElement('div');
    box.className = 'cakebox';
    Object.assign(box.style, {
      position: 'absolute',
      left: (cakeRect.left - stageRect.left - 24) + 'px',
      top: '-40vh',
      width: (cakeRect.width + 48) + 'px',
      height: (cakeRect.height + 48) + 'px',
      background: 'rgba(255,255,255,0.96)',
      borderRadius: '32px',
      boxShadow: '0 12px 48px 0 rgba(0,0,0,0.18)',
      zIndex: 9999,
      transition: 'top 0.7s cubic-bezier(.7,-0.3,.7,1.3), width 0.7s, height 0.7s, opacity 0.7s',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      overflow: 'visible'
    });
    // ë¦¬ë³¸ ì¶”ê°€
    const ribbon = document.createElement('div');
    ribbon.className = 'ribbon';
    ribbon.style.cssText = `
      position:absolute;top:-32px;left:50%;transform:translateX(-50%);
      width:120px;height:32px;background:linear-gradient(90deg,#ff69b4 60%,#ffd166 100%);
      border-radius:16px;box-shadow:0 2px 8px #ffb5c9;
      display:block;z-index:2;`
    box.appendChild(ribbon);
    stage.appendChild(box);

    // ë°•ìŠ¤ ë–¨ì–´ëœ¨ë¦¬ê¸°
    setTimeout(()=>{
      box.style.top = (cakeRect.top - stageRect.top - 24) + 'px';
    }, 30);

    // ë°•ìŠ¤ê°€ ì¼€ì´í¬ë¥¼ ê°€ë¦¬ë©´ ì¼€ì´í¬/í† í•‘/ìŠ¤í”„ë§í´/ì´ˆ ìˆ¨ê¹€
    setTimeout(()=>{
      cake.style.opacity = '0';
      [...document.querySelectorAll('.bit,.sprinkle,.candle')].forEach(n=>n.style.opacity = '0');
    }, 700);

    // ë°•ìŠ¤ ì‘ì•„ì§€ë©° í˜ì´ë“œì•„ì›ƒ
    setTimeout(()=>{
      box.style.width = '80px';
      box.style.height = '80px';
      box.style.opacity = '0';
    }, 1200);

    // ë°•ìŠ¤ ì œê±° ë° ì¼€ì´í¬ ë¦¬ì…‹
    setTimeout(()=>{
      box.remove();
      [...document.querySelectorAll('.bit,.sprinkle,.candle')].forEach(n=>n.remove());
      document.body.classList.remove('warm');
      candleOff();
      candlesLit = false;
      stacking.reset();
      cake.classList.remove('eaten');
      cake.style.opacity = '0';
      cake.style.transition = 'none';
      cake.style.top = '-40vh';

      // ì¼€ì´í¬ í˜ì´ë“œì¸ ì• ë‹ˆë©”ì´ì…˜ (ë“œë¡­ ì—†ì´)
      setTimeout(()=>{
        cake.style.transition = 'opacity 0.8s';
        cake.style.opacity = '1';
        setTimeout(()=>{
          cake.style.transition = '';
        }, 900);
      }, 400); // ë°•ìŠ¤ê°€ ì™„ì „íˆ ì‚¬ë¼ì§„ ë’¤ì— ì¼€ì´í¬ í˜ì´ë“œì¸
    }, 1800);
  // í•¨ìˆ˜ ë ì¤‘ê´„í˜¸ ì œê±° (ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì •)

  // ì—”í„°í‚¤ ë§¤í•‘ì€ handleKeyDownì—ì„œ ì²˜ë¦¬
  }

  // ===== Input handling + playful surprises =====
  const toppingMap = { 's':'ğŸ“','a':'ğŸ','b':'ğŸ«','c':'ğŸ’','g':'ğŸ‡','m':'ğŸ¥­','k':'ğŸ¥','p':'ğŸ‘','o':'ğŸŠ','l':'ğŸ‹' };
  let keyDownTimes = new Map(); // í‚¤ ëˆŒë¦¼ ì‹œì‘ ì‹œê°„ ì¶”ì 

  function checkLongPress(key, currentTime) {
    const startTime = keyDownTimes.get(key);
    if (startTime && (currentTime - startTime) >= 4000) { // 4ì´ˆ ì´ìƒ ëˆŒë €ì„ ë•Œ
      spawnBit({ emoji:'ğŸ‰', className:'topping', fromRoof:true, giant:true, group:true });
      keyDownTimes.delete(key); // í•œ ë²ˆ ìˆ˜ë°•ì„ ìƒì„±í•œ í›„ì—ëŠ” íƒ€ì´ë¨¸ ì´ˆê¸°í™”
      return true;
    }
    return false;
  }

  function handleKeyDown(e){
    // ì—”í„°í‚¤ë¡œ ì¼€ì´í¬ ê°€ì ¸ê°€ê¸°
    if(e.key === 'Enter'){
      guestEat();
      return;
    }
    if(e.key === ' '){ e.preventDefault(); }
    if(audioContext && audioContext.state === 'suspended') audioContext.resume();

    // í‚¤ ëˆŒë¦¼ ì‹œì‘ ì‹œê°„ ê¸°ë¡
    if (!keyDownTimes.has(e.key)) {
      keyDownTimes.set(e.key, Date.now());
    }

    if(e.key === '?' || (e.shiftKey && e.key === '/')){ hud.classList.toggle('hidden'); return; }

    // Space toggles candle lights
    if(e.key === ' '){ 
      document.querySelectorAll('.candle').forEach(c => c.classList.toggle('lit'));
      return;
    }

    // Enter to reset
    if(e.key === 'Enter'){ 
      [...document.querySelectorAll('.bit,.sprinkle,.candle')].forEach(n=>n.remove());
      return;
    }

    // Special characters create candles (long stick candle)
    if(/^[\[\]\\;'\/,`~!@#$%^&*()_+{}|:\"<>?]$/.test(e.key)){
      const candle = document.createElement('div');
      candle.className = 'candle';
      // ì°©ì§€ ìœ„ì¹˜ ê³„ì‚°
  const cr = cakeRect();
  // ì¼€ì´í¬ ê°€ë¡œ ë²”ìœ„ ë‚´ì—ì„œë§Œ ëœë¤ Xì¢Œí‘œ
  const cakeLeft = cr.left;
  const cakeRight = cr.right;
  const candleWidth = 5; // .candle CSS width
  const startX = randomBetween(cakeLeft, cakeRight - candleWidth);
  candle.style.left = startX + 'px';
  // ìº”ë“¤ ë†’ì´ ê³ ë ¤í•´ì„œ ì•„ë«ë¶€ë¶„ì´ ì¼€ì´í¬ í‘œë©´ì— ë‹¿ê²Œ ë³´ì •
  const candleHeight = 140; // .candle CSS height
  const surfaceY = cr.top + 20;
  const targetY_vp = surfaceY - candleHeight;
  const stageTop = stage.getBoundingClientRect().top;
  const finalTop = (targetY_vp - stageTop);
  candle.style.top = `${finalTop}px`;
      candle.style.opacity = 0.96;
      // ìƒ‰ìƒ ë‹¤ì–‘í™”: íŒŒìŠ¤í…” íŒ”ë ˆíŠ¸ì—ì„œ ëœë¤
      const pastelPalette = ['#ff7a99','#ffd166','#8be9fd','#c2ff8f','#b197fc','#ffb5c9','#c9f4ff','#ffecd6'];
      const pastelColor = pastelPalette[Math.floor(Math.random() * pastelPalette.length)];
      candle.style.background = `linear-gradient(to bottom, ${pastelColor}, #ffffff)`;
      // z-index
      candle.style.zIndex = Math.floor(Math.random() * 100);
      stage.appendChild(candle);
      blip(e.key);
      return;
    }

    // í‚¤ ê¸¸ê²Œ ëˆ„ë¥´ê¸° ì²´í¬ (ëª¨ë“  í‚¤ì— ëŒ€í•´)
    if (checkLongPress(e.key, Date.now())) {
      return;
    }

    // Numbers â†’ sprinkles
    if(/[0-9]/.test(e.key)){ sprinkle(); blip(e.key); return; }

    const keyLower = e.key.toLowerCase();

    // Fruits via explicit hotkeys only
    if(toppingMap[keyLower]){
      const emo = toppingMap[keyLower];
      spawnBit({ emoji: emo, className:'topping', fromRoof: Math.random()<0.5 });
      blip(keyLower);
      return;
    }

    // Letters and symbols â†’ falling letters (sometimes with pastel colors)
    if(e.key.length === 1){
      // 20% í™•ë¥ ë¡œ íŒŒìŠ¤í…” ìƒ‰ìƒ ì ìš©
      const color = Math.random() < 0.2 ? pastelPalette[Math.floor(Math.random() * pastelPalette.length)] : null;
      spawnBit({ text: e.key, className:'letter', fromRoof: Math.random()<0.6, color: color });
      blip(e.key);
      return;
    }

    // Backspace removes last landed element
    if(e.key === 'Backspace'){
      const bits = [...document.querySelectorAll('.bit')];
      if(bits.length){ bits[bits.length-1].remove(); }
      return;
    }
  }

  function handleKeyUp(e){
    // í‚¤ë¥¼ ë—„ ë•Œ í‚¤ ëˆŒë¦¼ ì‹œê°„ ì´ˆê¸°í™”
    keyDownTimes.delete(e.key);
  }

  // HUD toggle button + auto-hide
  hudToggle.addEventListener('click', ()=> {
    hud.classList.toggle('hidden');
    document.querySelector('.fruit-keys').style.display = 
      hud.classList.contains('hidden') ? 'none' : 'block';
  });
  setTimeout(()=> hud.classList.add('hidden'), 5200);

  // Reset pill button
  resetBtn.addEventListener('click', guestEat);

  window.addEventListener('keydown', handleKeyDown);
  window.addEventListener('keyup', handleKeyUp);

  // Reposition candles on resize
  window.addEventListener('resize', ()=>{ if(candlesLit) placeCandles(); });
  </script>
</body>
</html>
